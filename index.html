<html>
    <style>
        .numDisplayDiv {
            height: 40;
        }
    </style>
<body style="line-height: 2; font-family: 'Courier New', monospace;">
    <center>
    <b>Decimal Number</b>
    <!--
    <br>
    <input id="decimal" oninput="convert();"></input>
    <br>
    -->
    <div class="numDisplayDiv" id="decimal" contentEditable="true" oninput="convertFromDecimal();"></div>

    <b>Binary Representation</b>
    <div class="numDisplayDiv" id="outputBinary" contentEditable="true" oninput="convertFromBinary();"></div>

    <b>Hexadecimal Representation</b>
    <div class="numDisplayDiv" id="outputHex" contentEditable="true" oninput="convertFromHex();"></div>

    <b>Two's Complement</b>
    <div class="numDisplayDiv" id="outputTwosComplement" contentEditable="true" oninput="convertFromTwosComp();"></div>

    <b>Bits Needed To Store This Number</b>
    <div class="numDisplayDiv" id ="bitsNeeded" contentEditable="false" oninput=""></div>

    </center>
    
    <script>
        function setCharAt(str, idx, newChr)  { 
            return str.substring(0, idx) + newChr + str.substring(idx + 1);
        } 

        function setCursor(el, cursorPos) {
            var range = document.createRange()
            var sel = window.getSelection()
            
            range.setStart(el.childNodes[0], cursorPos)
            range.collapse(true)
            
            sel.removeAllRanges()
            sel.addRange(range)
        }

        function getCaretPosition(editableDiv) {
            var caretPos = 0,
                sel, range;
            if (window.getSelection) {
                sel = window.getSelection();
                if (sel.rangeCount) {
                range = sel.getRangeAt(0);
                if (range.commonAncestorContainer.parentNode == editableDiv) {
                    caretPos = range.endOffset;
                }
                }
            } else if (document.selection && document.selection.createRange) {
                range = document.selection.createRange();
                if (range.parentElement() == editableDiv) {
                var tempEl = document.createElement("span");
                editableDiv.insertBefore(tempEl, editableDiv.firstChild);
                var tempRange = range.duplicate();
                tempRange.moveToElementText(tempEl);
                tempRange.setEndPoint("EndToEnd", range);
                caretPos = tempRange.text.length;
                }
            }
            return caretPos;
         }

        // To allow users to input different representaions we'll convert the input to decimal first
        // then run the regular set of conversion functions.

        //======================Conversion Functions===========================

        // takes decimal
        function binary(x) {
            var i = 0;
            var binaryString = "";

            for (var count = 0; x > 0; count++) {
                i = x % 2;

                binaryString = i + binaryString;
                x = Math.floor(x / 2);
            }

            var c = 4 - binaryString.length % 4;
            if(c != 4) {
                for(;c > 0; c--) {
                    binaryString = "0" + binaryString;
                }
            }
                
            return binaryString;
        }

        // takes binary string
        function hex(s) {
            s = s.replace(/\s+/g, '');

            var hexString = "";
            var fourBitValue = 0;
            var c = 0;

            for (var i = s.length; i > 0; i--) {
                if (i % 4 == 0) {
                    fourBitValue += 1 * s[i-1];
                } else {
                    fourBitValue += Math.pow(2 * s[i-1], (s.length-i)%4);
                }

                if (i % 4 == 1) {
                    //console.log(fourBitValue);
                    hexString = fourBitValue.toString(16) + hexString;
                    //console.log(hexString);
                    fourBitValue = 0;
                }
            }

            return hexString.toUpperCase();
        }

        // takes binary string
        function twosComplement(s, addLeadingZeroes = true) {
            s = s.replace(/\s+/g, '');

            // we can just use JS built in functions, but they only do 32-bit
            // unsigned right shift zero to force number to be treated as unsigned representation 
            // return (-x >>> 0 ).toString(2).slice(32-b-1);

            var twosCompStr;
            if (addLeadingZeroes) {
                twosCompStr = "0000" + s;
            } else {
                twosCompStr = s;
            }
             
            // flip bits
            for (var i = 0; i < twosCompStr.length; i++) {
                if (twosCompStr[i] == "1") {
                    twosCompStr = setCharAt(twosCompStr, i, "0");
                } else {
                    twosCompStr = setCharAt(twosCompStr, i, "1");
                }
            }

            // add one
            var carry = 1;
            for (var i = twosCompStr.length-1; i >= 0; i--) {
                if (carry) {
                    if (twosCompStr[i] == "1") {
                        twosCompStr = setCharAt(twosCompStr, i, "0");
                    } else {
                        twosCompStr = setCharAt(twosCompStr, i, "1");
                        carry = 0;
                        break;
                    }
                }
            }

            return twosCompStr;
        }

        // takes decimal
        function bitsNeeded(n) {
            var b = 0;
            for (var i = 0; i < n; i += Math.pow(2, b++)){};

            return b;
        }

        //=============get user inputs as decimal========================== 
        function hexToDecimal() {
            var hexString = document.getElementById("outputHex").textContent;
            hexString = hexString.replace(/\s+/g, '');
            document.getElementById("decimal").textContent = parseInt(hexString, 16);
        }

        function binToDecimal() {
            var binString = document.getElementById("outputBinary").textContent;
            binString = binString.replace(/\s+/g, '');
            document.getElementById("decimal").textContent = parseInt(binString, 2);
        }

        function twosCompToDecimal() {
            var twosCompString = twosComplement(document.getElementById("outputTwosComplement").textContent, false);
            twosCompString = twosCompString.replace(/\s+/g, '');
            document.getElementById("decimal").textContent = parseInt(twosCompString, 2);
        }

        // ==================call these functions oninput==================
        function convertFromDecimal() {
            convert();
        }

        function convertFromBinary() {
            binToDecimal();
            convert('outputBinary');
        }
        
        function convertFromHex() {
            hexToDecimal();
            convert('outputHex');
        }

        function convertFromTwosComp() {
            twosCompToDecimal();
            convert('outputTwosComplement');
        }        

        var deletedChar = false;
        function convert(editing) {
            var decimal = Number(document.getElementById("decimal").textContent);
            var binaryString = binary(decimal);
            
            // don't replace text of conversion output user is editing
            if (editing != "outputBinary") {
                document.getElementById("outputBinary").textContent = binaryString.replace(/(.{4})/g,"$1 ");
            }

            if (editing != "outputHex") {
                document.getElementById("outputHex").textContent = hex(binaryString).replace(/(.{2})/g,"$1 ");
            }

            if (editing != "outputTwosComplement") {
                document.getElementById("outputTwosComplement").textContent = twosComplement(binaryString).replace(/(.{4})/g,"$1 ");
            }

            if (editing != "bitsNeeded") {
                document.getElementById("bitsNeeded").textContent = bitsNeeded(decimal);
            }      
            
            // format user's text input as they write
            var cursorPos = getCaretPosition(document.activeElement);
            document.activeElement.textContent = document.activeElement.textContent.replace(/\s+/g, '');

            if (editing == "outputBinary" || editing == "outputTwosComplement") {
                document.activeElement.textContent = document.activeElement.textContent.replace(/(.{4})/g,"$1 ");
            } else if (editing == "outputHex") {
                document.activeElement.textContent = document.activeElement.textContent.replace(/(.{2})/g,"$1 ");
            }

            // reset user's cursor to where they were last typing
            if (document.activeElement.textContent[cursorPos-1] == ' ' && cursorPos+1 <= document.activeElement.textContent.length && !deletedChar) {
                cursorPos++;
            }
            
            setCursor(document.activeElement, cursorPos);
            deletedChar = false;
        }

        window.addEventListener("keydown", function(e){
            if (e.code == "Delete" || e.code == "Backspace") {
                deletedChar = true;
            }
        });
    </script>
</body>
</html>
